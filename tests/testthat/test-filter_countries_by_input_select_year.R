context("Testing `filter_countries_by_input_select_year()`")

# df <- read_vp_flow_data()

pkg_data <- 
  system.file("extdata", "virtual-pollinators-flow.qs", package="vbpflow")

df <- 
  qread(pkg_data) %>%
  filter(item_code != 0) %>%
  .[.$reporter_countries != .$partner_countries, ]


# gxs_selection("filter_countries_by_input_select_year(df, 2001)")

## Testing 'filter_countries_by_input_select_year(df, 2001)'                ####
## Initially generated by xpectr
xpectr::set_test_seed(42)
# Assigning output
output_19148 <- filter_countries_by_input_select_year(df, 2001)
# Testing class
expect_equal(
  class(output_19148),
  c("spec_tbl_df", "tbl_df", "tbl", "data.frame"),
  fixed = TRUE)
# Testing column values
expect_equal(
  xpectr::smpl(output_19148[["reporter_country_code"]], n = 30),
  c(255, 27, 32, 33, 60, 68, 89, 101, 102, 105, 106, 112, 112, 131,
150, 150, 171, 117, 185, 203, 203, 223, 223, 223, 229, 229,
229, 215, 231, 231),
  tolerance = 1e-4)
expect_equal(
  xpectr::smpl(output_19148[["reporter_countries"]], n = 30),
  c("Belgium", "Bulgaria", "Cameroon", "Canada", "El Salvador", "France", 
    "Guatemala", "Indonesia", "Iran", "Israel", "Italy", "Jordan", 
    "Jordan", "Malaysia", "Netherlands", "Netherlands", "Philippines", 
    "South Korea", "Russia", "Spain", "Spain", "Turkey", "Turkey", 
    "Turkey", "United Kingdom", "United Kingdom", "United Kingdom", 
    "United Republic of Tanzania", "United States of America", "United States of America"),
  fixed = TRUE)
expect_equal(
  xpectr::smpl(output_19148[["item_code"]], n = 30),
  c(600, 490, 176, 181, 544, 268, 399, 176, 568, 490, 534, 397, 534,
692, 497, 544, 600, 220, 268, 397, 237, 399, 536, 176, 266,
656, 521, 217, 490, 230),
  tolerance = 1e-4)
expect_equal(
  xpectr::smpl(output_19148[["element"]], n = 30),
  c("Export Quantity", "Export Quantity", "Export Quantity", "Export Quantity", 
    "Export Quantity", "Export Quantity", "Export Quantity", "Export Quantity", 
    "Export Quantity", "Export Quantity", "Export Quantity", "Export Quantity", 
    "Export Quantity", "Export Quantity", "Export Quantity", "Export Quantity", 
    "Export Quantity", "Export Quantity", "Export Quantity", "Export Quantity", 
    "Export Quantity", "Export Quantity", "Export Quantity", "Export Quantity", 
    "Export Quantity", "Export Quantity", "Export Quantity", "Export Quantity", 
    "Export Quantity", "Export Quantity"),
  fixed = TRUE)
expect_equal(
  xpectr::smpl(output_19148[["partner_country_code"]], n = 30),
  c(211, 134, 46, 68, 89, 46, 95, 231, 229, 57, 54, 13, 252, 96, 186,
229, 156, 41, 223, 183, 217, 106, 118, 210, 121, 162, 200, 10,
156, 229),
  tolerance = 1e-4)
expect_equal(
  xpectr::smpl(output_19148[["partner_countries"]], n = 30),
  c("Switzerland", "Malta", "Republic of Congo", "France", "Guatemala", 
    "Republic of Congo", "Honduras", "United States of America", 
    "United Kingdom", "Belarus", "Denmark", "Bahrain", "Unspecified Area", 
    "Hong Kong S.A.R.", "Serbia and Montenegro", "United Kingdom", 
    "New Zealand", "China", "Turkey", "Romania", "Togo", "Italy", 
    "Kuwait", "Sweden", "Lebanon", "Norway", "Singapore", "Australia", 
    "New Zealand", "United Kingdom"),
  fixed = TRUE)
expect_equal(
  xpectr::smpl(output_19148[["item"]], n = 30),
  c("Papayas", "Oranges", "Beans, dry", "Broad beans, horse beans, dry", 
    "Strawberries", "Oil, sunflower", "Eggplants (aubergines)", 
    "Beans, dry", "Melons, other (inc.cantaloupes)", "Oranges", 
    "Peaches and nectarines", "Cucumbers and gherkins", "Peaches and nectarines", 
    "Vanilla", "Lemons and limes", "Strawberries", "Papayas", "Chestnut", 
    "Oil, sunflower", "Cucumbers and gherkins", "Oil, soybean", 
    "Eggplants (aubergines)", "Plums and sloes", "Beans, dry", "Oil, castor beans", 
    "Coffee, green", "Pears", "Cashew nuts, with shell", "Oranges", 
    "Cashew nuts, shelled"),
  fixed = TRUE)
expect_equal(
  xpectr::smpl(output_19148[["year"]], n = 30),
  c(2001, 2001, 2001, 2001, 2001, 2001, 2001, 2001, 2001, 2001, 2001,
2001, 2001, 2001, 2001, 2001, 2001, 2001, 2001, 2001, 2001,
2001, 2001, 2001, 2001, 2001, 2001, 2001, 2001, 2001),
  tolerance = 1e-4)
expect_equal(
  xpectr::smpl(output_19148[["traded_t"]], n = 30),
  c(2, 4, 2745, 43, 0, 9, 132, 6, 216, 116, 10799, 5743, 9, 4, 16,
3694, 5, 2867, 2017, 45, 1000, 2, 6, 11, 4, 9, 53, 100, 5116,
180),
  tolerance = 1e-4)
expect_equal(
  xpectr::smpl(output_19148[["adj_traded_t"]], n = 30),
  c(2, 4, 2745, 43, 0, 20, 132, 6, 216, 116, 10799, 5743, 9, 4, 16,
3694, 5, 2867, 4482.22222, 45, 5000, 2, 6, 11, 8.29876, 9, 53,
100, 5116, 720),
  tolerance = 1e-4)
expect_equal(
  xpectr::smpl(output_19148[["dependence_rate"]], n = 30),
  c(0.05, 0.05, 0.25, 0.25, 0.25, 0.25, 0.25, 0.25, 0.95, 0.05, 0.65,
0.65, 0.65, 0.95, 0.05, 0.25, 0.05, 0.25, 0.25, 0.65, 0.25,
0.25, 0.65, 0.25, 0.65, 0.25, 0.65, 0.65, 0.05, 0.65),
  tolerance = 1e-4)
expect_equal(
  xpectr::smpl(output_19148[["potential_poll_trade"]], n = 30),
  c(0.1, 0.2, 686.25, 10.75, 0, 5, 33, 1.5, 205.2, 5.8, 7019.35, 3732.95,
5.85, 3.8, 0.8, 923.5, 0.25, 716.75, 1120.55556, 29.25, 1250,
0.5, 3.9, 2.75, 5.39419, 2.25, 34.45, 65, 255.8, 468),
  tolerance = 1e-4)
expect_equal(
  xpectr::smpl(output_19148[["poll_provision"]], n = 30),
  c(0.26909, 0.21305, 0.19518, 0.16986, 0.55979, 0.23917, 0.51569,
0.36746, 0.44723, 0.3177, 0.22931, 0.2964, 0.2964, 0.60458,
0.36847, 0.36847, 0.45546, 0.59119, 0.21101, 0.33425, 0.33425,
0.34282, 0.34282, 0.34282, 0.27012, 0.27012, 0.27012, 0.76465,
0.25596, 0.25596),
  tolerance = 1e-4)
expect_equal(
  xpectr::smpl(output_19148[["vp_flow"]], n = 30),
  c(0.02691, 0.04261, 133.93914, 1.82598, 0, 1.19584, 17.01773, 0.55119,
91.77122, 1.84264, 1609.5896, 1106.43462, 1.73392, 2.29741,
0.29478, 340.28482, 0.11386, 423.73899, 236.45382, 9.77688,
417.81543, 0.17141, 1.33698, 0.94274, 1.45706, 0.60776, 9.30552,
49.70204, 65.47331, 119.78698),
  tolerance = 1e-4)
expect_equal(
  xpectr::smpl(output_19148[["reporter_long"]], n = 30),
  c(4.64065, 25.21553, 12.73964, -98.30777, -88.87164, -2.76173, -90.36482,
117.24011, 54.27407, 35.00445, 12.07001, 36.77136, 36.77136,
109.69762, 5.28145, 5.28145, 122.88393, 127.83916, 96.68656,
-3.64755, -3.64755, 35.16895, 35.16895, 35.16895, -2.86563,
-2.86563, -2.86563, 34.8131, -112.46167, -112.46167),
  tolerance = 1e-4)
expect_equal(
  xpectr::smpl(output_19148[["reporter_lat"]], n = 30),
  c(50.63982, 42.7689, 5.6911, 61.36206, 13.73944, 42.17344, 15.69404,
-2.21505, 32.57503, 31.4611, 42.79663, 31.24579, 31.24579, 3.78987,
52.10079, 52.10079, 11.77537, 36.38524, 61.98052, 40.24449,
40.24449, 39.0616, 39.0616, 39.0616, 54.12387, 54.12387, 54.12387,
-6.27565, 45.67955, 45.67955),
  tolerance = 1e-4)
expect_equal(
  xpectr::smpl(output_19148[["partner_long"]], n = 30),
  c(8.20867, 14.40523, 15.21966, -2.76173, -90.36482, 15.21966, -86.61517,
-112.46167, -2.86563, 28.03209, 10.02801, 50.54197, NA, 114.1138,
20.85498, -2.86563, 171.48492, 103.81907, 35.16895, 24.97293,
0.96233, 12.07001, 47.587, 16.74558, 35.88016, 15.34835, 103.81726,
134.491, 171.48492, -2.86563),
  tolerance = 1e-4)
expect_equal(
  xpectr::smpl(output_19148[["partner_lat"]], n = 30),
  c(46.79786, 35.9215, -0.83787, 42.17344, 15.69404, -0.83787, 14.82688,
45.67955, 54.12387, 53.53131, 55.98125, 26.04205, NA, 22.39828,
43.55966, 54.12387, -41.81114, 36.56177, 39.0616, 45.85243,
8.52531, 42.79663, 29.33431, 62.77967, 33.92307, 68.75016, 1.35876,
-25.73289, -41.81114, 54.12387),
  tolerance = 1e-4)
expect_equal(
  xpectr::smpl(output_19148[["reporter_hdi"]], n = 30),
  c(0.8964, 0.76613, 0.4938, 0.8976, 0.65547, 0.87527, 0.5956, 0.65033,
0.73693, 0.8806, 0.86293, 0.7268, 0.7268, 0.7572, 0.90367, 0.90367,
0.66013, 0.868, 0.7706, 0.85567, 0.85567, 0.72027, 0.72027,
0.72027, 0.89533, 0.89533, 0.89533, 0.47053, 0.90607, 0.90607),
  tolerance = 1e-4)
expect_equal(
  xpectr::smpl(output_19148[["partner_hdi"]], n = 30),
  c(0.9182, 0.82967, 0, 0.87527, 0.5956, 0, 0.58713, 0.90607, 0.89533,
0.75967, 0.90793, 0.79873, 0, 0.88707, 0.7516, 0.89533, 0.89507,
0.679, 0.72027, 0.77413, 0.45067, 0.86293, 0.79133, 0.90613,
0.74864, 0.93607, 0.8828, 0.91773, 0.89507, 0.89533),
  tolerance = 1e-4)
# Testing column names
expect_equal(
  names(output_19148),
  c("reporter_country_code", "reporter_countries", "item_code", "element", 
    "partner_country_code", "partner_countries", "item", "year", 
    "traded_t", "adj_traded_t", "dependence_rate", "potential_poll_trade", 
    "poll_provision", "vp_flow", "reporter_long", "reporter_lat", 
    "partner_long", "partner_lat", "reporter_hdi", "partner_hdi"),
  fixed = TRUE)
# Testing column classes
expect_equal(
  xpectr::element_classes(output_19148),
  c("numeric", "character", "numeric", "character", "numeric", "character", 
    "character", "numeric", "numeric", "numeric", "numeric", "numeric", 
    "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", 
    "numeric", "numeric"),
  fixed = TRUE)
# Testing column types
expect_equal(
  xpectr::element_types(output_19148),
  c("double", "character", "double", "character", "double", "character", 
    "character", "double", "double", "double", "double", "double", 
    "double", "double", "double", "double", "double", "double", 
    "double", "double"),
  fixed = TRUE)
# Testing dimensions
expect_equal(
  dim(output_19148),
  c(38132L, 20L))
# Testing group keys
expect_equal(
  colnames(dplyr::group_keys(output_19148)),
  character(0),
  fixed = TRUE)
## Finished testing 'filter_countries_by_input_select_year(df, 2001)'       ####
